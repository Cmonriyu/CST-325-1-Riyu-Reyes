<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Raytracer</title>
</head>
<body>
<canvas id='my-canvas'></canvas>

<script src='math/vector3.js'></script>
<script src='math/ray.js'></script>
<script src='math/sphere.js'></script>
<script src='math/plane.js'></script>
<script>

// Canvas setup, don't need to do anything in this section ************************
// Get a reference to the javascript object associated with the canvas
const canvas = document.getElementById('my-canvas');

// The canvas dimension we will set
const pixelsAcross = 256;  // pixels across
const pixelsDown = 256; // pixels down

// How much we scale a single pixel.  This has no effect on our computations. Change it to your liking.
const pixelScale = 3;

// Set up the size of our canvas in pixels
canvas.width = pixelsAcross;
canvas.height = pixelsDown;
canvas.style.cssText = 'width:' + (pixelsAcross * pixelScale) + 'px;height:' + (pixelsDown * pixelScale) + 'px';

// Get the context from the canvas (in this case we just want 2d)
const canvasContext = canvas.getContext('2d');

// Get an array representing all of the pixels
// Arranged left to right, top to bottom
const imageData = canvasContext.getImageData(0, 0, pixelsAcross, pixelsDown);
// end canvas setup section *****************************************************


// Raytracer scene data setup ***************************************************

// if this changes, your code should still work
const fov = 45; 
let fovRadians = fov * Math.PI/180; 
let pixelWidth = 2/256;
let pixelHalfWidth = pixelWidth / 2;

let eyeDistance = (canvas.width * pixelWidth / 2)/Math.tan(fovRadians/2); 
//     W/2
// -----------
// |         /
// |        /
// |       /
// | 45/2 /      <---- half angle
// |     /
// |    /
// |   /
// |  /
// | /

let eyeCoordinate = new Vector3(0,0, eyeDistance);

let sphere = new Sphere(new Vector3(0,0,0),.25); 
let plane = new Plane(new Vector3(0,1,0),new Vector3 (0,-.25,0))

// -----------------------------------------------------------------------------
function generateRayForPixel(xPixelIndex, yPixelIndex) {
	const pixelX = -1 + pixelHalfWidth + pixelWidth * xPixelIndex;
	const pixelY = 1 - pixelHalfWidth - pixelWidth * yPixelIndex;
	const pixelCoordinate = new Vector3(pixelX, pixelY, 0);

	let direction = pixelCoordinate.subtract(eyeCoordinate);
	let pixelRay = new Ray(eyeCoordinate,direction);
	return pixelRay;
}

// -----------------------------------------------------------------------------
function setPixelColor(xPixelIndex, yPixelIndex, shadeOfGray /*[0,1]*/) {
	const index = (yPixelIndex * pixelsAcross + xPixelIndex) * 4; // 4 bytes per pixel
	imageData.data[index + 0] = shadeOfGray * 255; // red channel
	imageData.data[index + 1] = shadeOfGray * 255; // green channel
	imageData.data[index + 2] = shadeOfGray * 255; // blue channel
	imageData.data[index + 3] = 255;
}

// -----------------------------------------------------------------------------
function updateAndRender(timeElapsed) {
	const lightposition = new Vector3(1,0,0);
	for (let yPixelIndex = 0; yPixelIndex < pixelsDown; ++yPixelIndex) {
		for (let xPixelIndex = 0; xPixelIndex < pixelsAcross; ++xPixelIndex) {

			const pixelRay = generateRayForPixel(xPixelIndex, yPixelIndex);
			const sphereResult = sphere.raycast(pixelRay);
			const planeResult = plane.raycast(pixelRay);

			var maxValue = Math.sin(Math.sqrt(2) / 4);
			if (sphereResult.hit && planeResult.hit){
				if (sphereResult.distance < planeResult.distance){
					setPixelColor(xPixelIndex, yPixelIndex, 0.8);
				} else {
					setPixelColor(xPixelIndex, yPixelIndex, 0.5);
				}
			} else if (sphereResult.hit){
				setPixelColor(xPixelIndex, yPixelIndex, 0.8); // middle gray
			} else if (planeResult.hit) {
				setPixelColor(xPixelIndex, yPixelIndex, 0.5); // dark gray
			} else {
				setPixelColor(xPixelIndex, yPixelIndex, 0.1); 
			}
		}
	}

	canvasContext.putImageData(imageData, 0, 0);

	requestAnimationFrame(updateAndRender);
}

requestAnimationFrame(updateAndRender);

</script>
<script src="raytracer-tests.js"></script>
</body>
</html>
